name: Release

on:
  push:
    tags:
      - "v*"

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

permissions:
  contents: write

jobs:
  # ÂàõÂª∫ Release
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ env.VERSION }}
    steps:
      - name: Get version from tag
        id: tag_name
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.VERSION }}
          release_name: Release ${{ env.VERSION }}
          draft: false
          prerelease: false

  # Linux x86_64 DEB
  build-linux-x86_64:
    name: Build Linux x86_64 DEB
    runs-on: ubuntu-latest
    needs: create-release
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Build
        run: |
          cargo build --release --target x86_64-unknown-linux-gnu --bin tron-vanity

      - name: Create DEB Package
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          DEB_VERSION="${VERSION#v}"
          mkdir -p deb_build/DEBIAN
          mkdir -p deb_build/usr/local/bin

          cp target/x86_64-unknown-linux-gnu/release/tron-vanity deb_build/usr/local/bin/
          chmod +x deb_build/usr/local/bin/tron-vanity

          cat > deb_build/DEBIAN/control << EOF
          Package: tron-vanity
          Version: $DEB_VERSION
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: TRON Developer <dev@tron.org>
          Description: Multi-chain vanity address generator
           Fast TRON/EVM/SOL vanity address generator with GUI and CLI.
          EOF

          dpkg-deb --build deb_build tron-vanity_${DEB_VERSION}_amd64.deb
          mkdir -p dist
          mv tron-vanity_${DEB_VERSION}_amd64.deb dist/
          ls -lh dist/*.deb

      - name: Upload DEB Package
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.create-release.outputs.version }}
          files: dist/tron-vanity_${{ needs.create-release.outputs.version }}_amd64.deb

  # Linux ARM64 DEB
  build-linux-arm64:
    name: Build Linux ARM64 DEB
    runs-on: ubuntu-latest
    needs: create-release
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-gnu

      - name: Install ARM64 toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Build
        env:
          CC_aarch64_unknown_linux_gnu: aarch64-linux-gnu-gcc
          AR_aarch64_unknown_linux_gnu: aarch64-linux-gnu-ar
        run: |
          cargo build --release --target aarch64-unknown-linux-gnu --bin tron-vanity

      - name: Create DEB Package
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          DEB_VERSION="${VERSION#v}"
          mkdir -p deb_build/DEBIAN
          mkdir -p deb_build/usr/local/bin

          cp target/aarch64-unknown-linux-gnu/release/tron-vanity deb_build/usr/local/bin/
          chmod +x deb_build/usr/local/bin/tron-vanity

          cat > deb_build/DEBIAN/control << EOF
          Package: tron-vanity
          Version: $DEB_VERSION
          Section: utils
          Priority: optional
          Architecture: arm64
          Maintainer: TRON Developer <dev@tron.org>
          Description: Multi-chain vanity address generator
           Fast TRON/EVM/SOL vanity address generator with GUI and CLI.
          EOF

          dpkg-deb --build deb_build tron-vanity_${DEB_VERSION}_arm64.deb
          mkdir -p dist
          mv tron-vanity_${DEB_VERSION}_arm64.deb dist/
          ls -lh dist/*.deb

      - name: Upload DEB Package
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.create-release.outputs.version }}
          files: dist/tron-vanity_${{ needs.create-release.outputs.version }}_arm64.deb

  # macOS x86_64 DMG
  build-macos-x86_64:
    name: Build macOS x86_64 DMG
    runs-on: macos-latest
    needs: create-release
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin

      - name: Build
        run: |
          cargo build --release --target x86_64-apple-darwin --bin tron-vanity

      - name: Code Sign (optional)
        run: |
          codesign -s - target/x86_64-apple-darwin/release/tron-vanity || true

      - name: Create DMG Package
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          mkdir -p dmg_staging
          mkdir -p dist
          cp target/x86_64-apple-darwin/release/tron-vanity dmg_staging/
          hdiutil create -volname "tron-vanity" -srcfolder dmg_staging -ov -format UDZO dist/tron-vanity_${VERSION}_macos-x86_64.dmg
          ls -lh dist/*.dmg

      - name: Upload DMG Package
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.create-release.outputs.version }}
          files: dist/tron-vanity_${{ needs.create-release.outputs.version }}_macos-x86_64.dmg

  # macOS ARM64 DMG
  build-macos-arm64:
    name: Build macOS ARM64 DMG
    runs-on: macos-latest
    needs: create-release
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Build
        run: |
          cargo build --release --target aarch64-apple-darwin --bin tron-vanity

      - name: Code Sign (optional)
        run: |
          codesign -s - target/aarch64-apple-darwin/release/tron-vanity || true

      - name: Create DMG Package
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          mkdir -p dmg_staging
          mkdir -p dist
          cp target/aarch64-apple-darwin/release/tron-vanity dmg_staging/
          hdiutil create -volname "tron-vanity" -srcfolder dmg_staging -ov -format UDZO dist/tron-vanity_${VERSION}_macos-arm64.dmg
          ls -lh dist/*.dmg

      - name: Upload DMG Package
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.create-release.outputs.version }}
          files: dist/tron-vanity_${{ needs.create-release.outputs.version }}_macos-arm64.dmg

  # Windows x86_64 MSI
  build-windows-x86_64:
    name: Build Windows x86_64 MSI
    runs-on: windows-latest
    needs: create-release
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Build
        run: |
          cargo build --release --target x86_64-pc-windows-msvc --bin tron-vanity

      - name: Install WiX
        run: |
          dotnet tool install --global wix
          wix extension add WixUI.wixext
        shell: pwsh

      - name: Create MSI Installer
        run: |
          mkdir -p dist
          copy target/x86_64-pc-windows-msvc/release/tron-vanity.exe dist/

          $VERSION = "${{ needs.create-release.outputs.version }}" -replace 'v', ''
          $WixContent = @"
          <?xml version="1.0" encoding="UTF-8"?>
          <Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
            <Product Id="*" Name="TRON Vanity" Language="1033" Version="$VERSION" Manufacturer="TRON Developer" UpgradeCode="12345678-1234-1234-1234-123456789012">
              <Package InstallerVersion="200" Compressed="yes" Platform="x64" InstallScope="perMachine" />
              <Media Id="1" Cabinet="tron-vanity.cab" EmbedCab="yes" />
              <Directory Id="TARGETDIR" Name="SourceDir">
                <Directory Id="ProgramFilesFolder">
                  <Directory Id="INSTALLFOLDER" Name="TRON Vanity" />
                </Directory>
              </Directory>
              <Feature Id="ProductFeature" Title="TRON Vanity" Level="1">
                <ComponentRef Id="MainEXE" />
              </Feature>
              <UIRef Id="WixUI_InstallDir" />
            </Product>
            <Fragment>
              <DirectoryRef Id="INSTALLFOLDER">
                <Component Id="MainEXE" Guid="*">
                  <File Id="TronVanity" Name="tron-vanity.exe" Source="dist/tron-vanity.exe" KeyPath="yes" />
                </Component>
              </DirectoryRef>
            </Fragment>
          </Wix>
          "@

          $WixContent | Out-File -Encoding UTF8 product.wxs
          wix build product.wxs -o dist/tron-vanity_${VERSION}_windows-x86_64.msi
          Get-Item dist/*.msi | ForEach-Object { Write-Host "$($_.FullName) $($_.Length) bytes" }
        shell: pwsh

      - name: Upload MSI Installer
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.create-release.outputs.version }}
          files: dist/tron-vanity_${{ needs.create-release.outputs.version }}_windows-x86_64.msi

  # Windows ARM64 MSI
  build-windows-arm64:
    name: Build Windows ARM64 MSI
    runs-on: windows-latest
    needs: create-release
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-pc-windows-msvc

      - name: Build
        run: |
          cargo build --release --target aarch64-pc-windows-msvc --bin tron-vanity

      - name: Install WiX
        run: |
          dotnet tool install --global wix
          wix extension add WixUI.wixext
        shell: pwsh

      - name: Create MSI Installer
        run: |
          mkdir -p dist
          copy target/aarch64-pc-windows-msvc/release/tron-vanity.exe dist/

          $VERSION = "${{ needs.create-release.outputs.version }}" -replace 'v', ''
          $WixContent = @"
          <?xml version="1.0" encoding="UTF-8"?>
          <Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
            <Product Id="*" Name="TRON Vanity" Language="1033" Version="$VERSION" Manufacturer="TRON Developer" UpgradeCode="87654321-4321-4321-4321-210987654321">
              <Package InstallerVersion="200" Compressed="yes" Platform="arm64" InstallScope="perMachine" />
              <Media Id="1" Cabinet="tron-vanity.cab" EmbedCab="yes" />
              <Directory Id="TARGETDIR" Name="SourceDir">
                <Directory Id="ProgramFilesFolder">
                  <Directory Id="INSTALLFOLDER" Name="TRON Vanity" />
                </Directory>
              </Directory>
              <Feature Id="ProductFeature" Title="TRON Vanity" Level="1">
                <ComponentRef Id="MainEXE" />
              </Feature>
              <UIRef Id="WixUI_InstallDir" />
            </Product>
            <Fragment>
              <DirectoryRef Id="INSTALLFOLDER">
                <Component Id="MainEXE" Guid="*">
                  <File Id="TronVanity" Name="tron-vanity.exe" Source="dist/tron-vanity.exe" KeyPath="yes" />
                </Component>
              </DirectoryRef>
            </Fragment>
          </Wix>
          "@

          $WixContent | Out-File -Encoding UTF8 product.wxs
          wix build product.wxs -o dist/tron-vanity_${VERSION}_windows-arm64.msi
          Get-Item dist/*.msi | ForEach-Object { Write-Host "$($_.FullName) $($_.Length) bytes" }
        shell: pwsh

      - name: Upload MSI Installer
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.create-release.outputs.version }}
          files: dist/tron-vanity_${{ needs.create-release.outputs.version }}_windows-arm64.msi

  # ÂèëÂ∏ÉÂÆåÊàêÈÄöÁü•
  publish-complete:
    name: Publish Complete
    runs-on: ubuntu-latest
    needs:
      [
        build-linux-x86_64,
        build-linux-arm64,
        build-macos-x86_64,
        build-macos-arm64,
        build-windows-x86_64,
        build-windows-arm64,
        create-release,
      ]
    if: always()
    steps:
      - name: Check build status
        run: |
          echo "‚úÖ All builds completed!"
          echo "Release: ${{ needs.create-release.outputs.version }}"
          echo "üì¶ Installers available:"
          echo "  - Linux: .deb packages (amd64, arm64)"
          echo "  - macOS: .dmg packages (x86_64, arm64)"
          echo "  - Windows: .msi installers (x86_64, arm64)"
          echo "Download from GitHub Release page"
